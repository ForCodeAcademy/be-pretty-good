
import React, { useState, useEffect, useCallback } from "react";
import { MoodEntry } from "@/entities/MoodEntry"; // Assuming MoodEntry entity is updated to hold wellness data or will be replaced.
import { MonthlyWealthEntry } from "@/entities/MonthlyWealthEntry"; // New import for MonthlyWealthEntry
import { WeeklyRelationshipEntry } from "@/entities/WeeklyRelationshipEntry"; // New import for WeeklyRelationshipEntry
import { Calendar, TrendingUp, Filter, Brain, Users, DollarSign, Heart } from "lucide-react"; // Added Heart; Removed Moon, Utensils, Dumbbell
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { motion } from "framer-motion";
import WellnessEntryCard from "../components/mood/WellnessEntryCard"; // Changed from MoodEntryCard
import { format, getISOWeek, getYear } from "date-fns"; // New import for date formatting and week/year extraction

export default function MoodHistory() { // Keeping function name MoodHistory as per original, but content changes to wellness
  const [entries, setEntries] = useState([]);
  const [wealthEntries, setWealthEntries] = useState({}); // New state for monthly wealth entries
  const [relationshipEntries, setRelationshipEntries] = useState({}); // New state for weekly relationship entries
  const [filteredEntries, setFilteredEntries] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [filter, setFilter] = useState("all");

  // Memoize loadEntries with useCallback to ensure a stable function reference
  const loadEntries = useCallback(async () => {
    setIsLoading(true);
    // Assuming MoodEntry.list now fetches entries with the new wellness dimensions,
    // or MoodEntry entity is repurposed/replaced for Wellness entries.
    const dailyData = await MoodEntry.list("-date"); 
    setEntries(dailyData);

    // Fetch monthly wealth entries
    const monthlyData = await MonthlyWealthEntry.list();
    // Convert monthly wealth data into a map for easier lookup by 'yyyy-MM'
    const wealthMap = monthlyData.reduce((acc, entry) => {
      acc[entry.month_year] = entry; // Assuming entry has a 'month_year' field like "2023-10"
      return acc;
    }, {});
    setWealthEntries(wealthMap);

    // Fetch weekly relationship entries
    const weeklyData = await WeeklyRelationshipEntry.list();
    // Convert weekly relationship data into a map for easier lookup by 'yyyy-WW'
    const relationshipMap = weeklyData.reduce((acc, entry) => {
      acc[entry.week_year] = entry; // Assuming entry has a 'week_year' field like "2023-40"
      return acc;
    }, {});
    setRelationshipEntries(relationshipMap);

    setIsLoading(false);
  }, []); // No dependencies for loadEntries itself, as it's meant to fetch initial data

  useEffect(() => {
    loadEntries();
  }, [loadEntries]); // Add loadEntries to dependency array

  // Memoize applyFilter with useCallback to ensure a stable function reference
  // This prevents infinite re-renders when applyFilter is used in useEffect dependencies
  const applyFilter = useCallback(() => {
    let filtered = [...entries];
    
    if (filter !== "all") {
      filtered = entries.filter(entry => {
        // Physical Health
        const physicalHealth = ((entry.sleep || 0) + (entry.food || 0) + (entry.exercise || 0)) / 3;

        // Mental Health
        const mentalHealth = ((entry.stress || 0) + (entry.self_belief || 0) + (entry.hope || 0)) / 3;

        // Relationships - now pulled from weekly entries
        const entryDate = new Date(entry.date);
        const week = getISOWeek(entryDate);
        const year = getYear(entryDate);
        const weekYear = `${year}-${week.toString().padStart(2, '0')}`;
        const weekRelationship = relationshipEntries[weekYear];
        // Calculate relationships score from weekly partner_kids, wider_family, friends. If no weekly entry, relationships is 0.
        const relationships = weekRelationship ? ((weekRelationship.partner_kids + weekRelationship.wider_family + weekRelationship.friends) / 3) : 0;

        // Wealth - from monthly entries
        const monthYear = format(entryDate, "yyyy-MM");
        const monthWealth = wealthEntries[monthYear]; // Get monthly wealth for the entry's month/year
        // Calculate wealth score from monthly income, savings, outgoings. If no monthly entry, wealth is 0.
        const wealth = monthWealth ? ((monthWealth.income + monthWealth.savings + monthWealth.outgoings) / 3) : 0;
        
        // Overall average now based on up to 4 dimensions: Physical Health, Mental Health, Relationships, Wealth
        let dimensions = 2; // Physical and Mental are always present daily
        let totalScore = physicalHealth + mentalHealth;

        if (relationships > 0) {
            dimensions++;
            totalScore += relationships;
        }
        if (wealth > 0) {
            dimensions++;
            totalScore += wealth;
        }
        const avg = totalScore / dimensions;

        if (filter === "excellent") return avg >= 3.25;
        if (filter === "pretty_good") return avg >= 2.5 && avg < 3.25;
        if (filter === "okay") return avg >= 1.75 && avg < 2.5;
        if (filter === "bad") return avg < 1.75;
        return true;
      });
    }
    
    setFilteredEntries(filtered);
  }, [entries, filter, wealthEntries, relationshipEntries]); // Dependencies for useCallback: entries, filter, wealthEntries, and relationshipEntries

  // Updated useEffect with applyFilter in its dependency array.
  // Since applyFilter is now memoized, this will not cause infinite re-renders.
  useEffect(() => {
    applyFilter();
  }, [entries, filter, applyFilter]);

  // Changed to getWellnessStats to reflect new rating system
  const getWellnessStats = () => {
    if (entries.length === 0) return null;
    
    // Calculate average for Physical Health (from daily entries)
    const avgPhysicalHealth = entries.reduce((sum, entry) => {
      const sleep = entry.sleep || 0;
      const food = entry.food || 0;
      const exercise = entry.exercise || 0;
      return sum + (sleep + food + exercise) / 3; // Average of the three
    }, 0) / entries.length;
    
    // Calculate average for Mental Health from Stress, Self-belief, Hope (from daily entries)
    const avgMentalHealth = entries.reduce((sum, entry) => {
      const stress = entry.stress || 0;
      const self_belief = entry.self_belief || 0;
      const hope = entry.hope || 0;
      return sum + (stress + self_belief + hope) / 3;
    }, 0) / entries.length;

    // --- NEW: Calculate average relationships from weekly relationship entries ---
    const weeklyRelationshipEntries = Object.values(relationshipEntries);
    const avgRelationships = weeklyRelationshipEntries.length > 0 
      ? weeklyRelationshipEntries.reduce((sum, entry) => sum + ((entry.partner_kids || 0) + (entry.wider_family || 0) + (entry.friends || 0)) / 3, 0) / weeklyRelationshipEntries.length
      : 0;

    // --- NEW: Calculate average wealth from monthly wealth entries ---
    const monthlyWealthEntries = Object.values(wealthEntries);
    const avgWealth = monthlyWealthEntries.length > 0 
      ? monthlyWealthEntries.reduce((sum, entry) => sum + ((entry.income || 0) + (entry.savings || 0) + (entry.outgoings || 0)) / 3, 0) / monthlyWealthEntries.length
      : 0;
    
    // Overall average now based on up to 4 dimensions: Physical Health, Mental Health, Relationships, Wealth
    let dimensions = 2; // Physical and Mental are always present daily averages
    let totalAvgScore = avgPhysicalHealth + avgMentalHealth;

    if (avgRelationships > 0) {
        dimensions++;
        totalAvgScore += avgRelationships;
    }
    if (avgWealth > 0) {
        dimensions++;
        totalAvgScore += avgWealth;
    }
    const overallAvg = totalAvgScore / dimensions;
    
    return {
      total: entries.length,
      overallAvg: overallAvg.toFixed(1),
      avgPhysicalHealth: avgPhysicalHealth.toFixed(1),
      avgMentalHealth: avgMentalHealth.toFixed(1), // Changed key
      avgRelationships: avgRelationships.toFixed(1),
      avgWealth: avgWealth.toFixed(1)
    };
  };

  const stats = getWellnessStats(); // Use new wellness stats

  return (
    <div className="min-h-screen p-4 md:p-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
              <Calendar className="w-8 h-8 text-sage-500" />
              Wellness History {/* Changed title */}
            </h1>
            <p className="text-sage-600 mt-1">Your journey across all life areas</p> {/* Changed description */}
          </div>
          
          <div className="flex items-center gap-3">
            <Filter className="w-4 h-4 text-sage-600" />
            <Select value={filter} onValueChange={setFilter}>
              <SelectTrigger className="w-40 border-sage-200">
                <SelectValue placeholder="Filter entries" /> {/* Changed placeholder */}
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Entries</SelectItem> {/* Changed label */}
                <SelectItem value="excellent">Excellent (3.25+ Avg)</SelectItem>
                <SelectItem value="pretty_good">Pretty Good (2.5-3.24 Avg)</SelectItem>
                <SelectItem value="okay">Okay (1.75-2.49 Avg)</SelectItem>
                <SelectItem value="bad">Bad (&lt;1.75 Avg)</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Stats */}
        {stats && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8" // Updated grid cols to 5 (Total, Physical, Mental, Social, Wealth)
          >
            {/* Total Entries Card */}
            <div className="bg-gradient-to-br from-sage-50 to-sage-100 rounded-2xl p-6 border border-sage-200">
              <div className="flex items-center gap-3 mb-2">
                <TrendingUp className="w-5 h-5 text-sage-600" />
                <span className="text-sage-700 font-medium">Total</span>
              </div>
              <div className="text-2xl font-bold text-gray-900">{stats.total}</div>
              <div className="text-xs text-sage-600">entries</div>
            </div>
            
            {/* Physical Health Card - NEW */}
            <div className="bg-gradient-to-br from-red-50 to-pink-100 rounded-2xl p-6 border border-red-200">
              <div className="flex items-center gap-3 mb-2">
                <Heart className="w-5 h-5 text-red-600" />
                <span className="text-red-700 font-medium">Physical</span>
              </div>
              <div className="text-2xl font-bold text-gray-900">{stats.avgPhysicalHealth}</div>
              <div className="text-xs text-red-600">average</div>
            </div>
            
            {/* Mental Health Card */}
            <div className="bg-gradient-to-br from-purple-50 to-indigo-100 rounded-2xl p-6 border border-purple-200">
              <div className="flex items-center gap-3 mb-2">
                <Brain className="w-5 h-5 text-purple-600" />
                <span className="text-purple-700 font-medium">Mental</span>
              </div>
              <div className="text-2xl font-bold text-gray-900">{stats.avgMentalHealth}</div> {/* Updated to avgMentalHealth */}
              <div className="text-xs text-purple-600">average</div>
            </div>
            
            {/* Relationships Card */}
            <div className="bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl p-6 border border-green-200">
              <div className="flex items-center gap-3 mb-2">
                <Users className="w-5 h-5 text-green-600" />
                <span className="text-green-700 font-medium">Social</span>
              </div>
              <div className="text-2xl font-bold text-gray-900">{stats.avgRelationships}</div>
              <div className="text-xs text-green-600">weekly avg</div> {/* Updated label */}
            </div>
            
            {/* Wealth Card */}
            <div className="bg-gradient-to-br from-yellow-50 to-orange-100 rounded-2xl p-6 border border-yellow-200">
              <div className="flex items-center gap-3 mb-2">
                <DollarSign className="w-5 h-5 text-yellow-600" />
                <span className="text-yellow-700 font-medium">Wealth</span>
              </div>
              <div className="text-2xl font-bold text-gray-900">{stats.avgWealth}</div>
              <div className="text-xs text-yellow-600">monthly avg</div> {/* Updated label */}
            </div>
          </motion.div>
        )}

        {/* Entries */}
        <div className="space-y-6">
          {isLoading ? (
            <div className="grid grid-cols-1 gap-6">
              {Array.from({ length: 4 }).map((_, i) => (
                <div key={i} className="bg-gray-200 animate-pulse rounded-2xl h-40" />
              ))}
            </div>
          ) : filteredEntries.length === 0 ? (
            <div className="text-center py-12">
              <Calendar className="w-16 h-16 text-sage-300 mx-auto mb-4" />
              <h3 className="text-xl font-medium text-gray-900 mb-2">
                {filter === "all" ? "No entries yet" : "No entries match this filter"}
              </h3>
              <p className="text-sage-600">
                {filter === "all" 
                  ? "Start tracking your daily wellness to see your history here"
                  : "Try selecting a different filter"
                }
              </p>
            </div>
          ) : (
            <div className="space-y-6">
              {filteredEntries.map((entry, index) => {
                const entryDate = new Date(entry.date);
                const week = getISOWeek(entryDate);
                const year = getYear(entryDate);
                const weekYear = `${year}-${week.toString().padStart(2, '0')}`;
                const weeklyEntry = relationshipEntries[weekYear];
                // Calculate the weekly relationship average rating for this entry's week, or null if no data
                const weeklyRelationshipRating = weeklyEntry ? (
                    ((weeklyEntry.partner_kids || 0) + (weeklyEntry.wider_family || 0) + (weeklyEntry.friends || 0)) / 3
                ) : null;

                return (
                    <WellnessEntryCard 
                        key={entry.id} 
                        entry={entry} 
                        index={index} 
                        weeklyRelationshipRating={weeklyRelationshipRating} 
                    />
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
